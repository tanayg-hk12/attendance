<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Program Attendance Sheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"] {
            width: 100%;
            border: none;
            padding: 5px;
            box-sizing: border-box;
        }
        select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
        }
        .reason-field {
            display: none;
            margin-top: 5px;
        }
        .reason-field input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 5px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #sendMessageBtn {
            background-color: #2196F3;
        }
        #sendMessageBtn:hover {
            background-color: #0b7dda;
        }
        #phoneNumber {
            padding: 10px;
            margin: 5px;
            width: 200px;
        }
        .delete-btn {
            background-color: #f44336;
            padding: 5px 10px;
            font-size: 12px;
            width: 100%;
        }
        .delete-btn:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <h1>Morning Program Attendance Sheet</h1>
    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Chanting</th>
                <th>MA</th>
                <th>SB Class</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Rows will be populated here -->
        </tbody>
    </table>
    <button id="addRowBtn">Add Row</button>
    <br><br>
    <label for="phoneNumber">Enter 10-digit Indian Phone Number:</label>
    <input type="text" id="phoneNumber" placeholder="e.g., 9876543210" maxlength="10">
    <button id="sendMessageBtn">Send Message</button>

    <script>
        const tableBody = document.getElementById('tableBody');
        const addRowBtn = document.getElementById('addRowBtn');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const phoneNumberInput = document.getElementById('phoneNumber');

        let rowId = 0;
        let db = null;
        const DB_NAME = 'AttendanceDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'attendanceStore';

        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const upgradeDb = event.target.result;
                    if (!upgradeDb.objectStoreNames.contains(STORE_NAME)) {
                        upgradeDb.createObjectStore(STORE_NAME, { keyPath: 'key' });
                    }
                };
            });
        }

        // Load phone number from IndexedDB
        async function loadPhoneNumber() {
            if (!db) return;
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('savedPhoneNumber');
                request.onsuccess = () => {
                    const savedPhone = request.result ? request.result.value : null;
                    if (savedPhone) {
                        phoneNumberInput.value = savedPhone;
                    }
                    resolve();
                };
                request.onerror = () => resolve();
            });
        }

        // Save phone number to IndexedDB
        async function savePhoneNumber() {
            if (!db) return;
            const phone = phoneNumberInput.value.trim();
            if (!phone) return;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            await store.put({ key: 'savedPhoneNumber', value: phone });
        }

        // Load data from IndexedDB
        async function loadData() {
            if (!db) return;
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('attendanceData');
                request.onsuccess = () => {
                    const savedData = request.result ? request.result.value : null;
                    if (savedData && Array.isArray(savedData)) {
                        savedData.forEach((row) => {
                            addRow(
                                row.name || '',
                                row.chanting || 'Present',
                                row.ma || 'Present',
                                row.sb || 'Present',
                                row.id,
                                row.chantingReason || '',
                                row.maReason || '',
                                row.sbReason || ''
                            );
                        });
                        // Set rowId to next available ID
                        if (savedData.length > 0) {
                            const maxId = Math.max(...savedData.map(r => r.id || 0));
                            rowId = maxId + 1;
                        }
                    }
                    resolve();
                };
                request.onerror = () => resolve();
            });
        }

        // Save data to IndexedDB
        async function saveData() {
            if (!db) return;
            const data = [];
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 5) {
                    const nameInput = cells[0].querySelector('input');
                    const chantingSelect = cells[1].querySelector('select');
                    const chantingReasonInput = cells[1].querySelector('.reason-field input');
                    const maSelect = cells[2].querySelector('select');
                    const maReasonInput = cells[2].querySelector('.reason-field input');
                    const sbSelect = cells[3].querySelector('select');
                    const sbReasonInput = cells[3].querySelector('.reason-field input');
                    
                    const rowData = {
                        id: parseInt(row.dataset.rowId) || rowId++,
                        name: nameInput ? nameInput.value : '',
                        chanting: chantingSelect ? chantingSelect.value : 'Present',
                        chantingReason: chantingReasonInput ? chantingReasonInput.value : '',
                        ma: maSelect ? maSelect.value : 'Present',
                        maReason: maReasonInput ? maReasonInput.value : '',
                        sb: sbSelect ? sbSelect.value : 'Present',
                        sbReason: sbReasonInput ? sbReasonInput.value : ''
                    };
                    data.push(rowData);
                }
            });
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            await store.put({ key: 'attendanceData', value: data });
        }

        // Toggle reason field visibility
        function toggleReasonField(selectElement, reasonField) {
            const isAbsentOrLate = selectElement.value === 'Absent' || selectElement.value === 'Late';
            if (isAbsentOrLate) {
                reasonField.style.display = 'block';
            } else {
                reasonField.style.display = 'none';
                const reasonInput = reasonField.querySelector('input');
                if (reasonInput) {
                    reasonInput.value = '';
                }
            }
            saveData(); // Fire and forget
        }

        // Add a new row
        function addRow(name = '', chanting = 'Present', ma = 'Present', sb = 'Present', id = null, chantingReason = '', maReason = '', sbReason = '') {
            const row = document.createElement('tr');
            const actualId = id !== null ? id : rowId++;
            row.dataset.rowId = actualId;
            
            // Name cell
            const nameCell = document.createElement('td');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = name;
            nameInput.onblur = () => saveData();
            nameCell.appendChild(nameInput);
            
            // Chanting cell
            const chantingCell = document.createElement('td');
            const chantingSelect = document.createElement('select');
            chantingSelect.innerHTML = '<option value="Present">Present</option><option value="Absent">Absent</option><option value="Late">Late</option>';
            chantingSelect.value = chanting;
            chantingSelect.onchange = () => {
                toggleReasonField(chantingSelect, chantingReasonField);
            };
            
            const chantingReasonField = document.createElement('div');
            chantingReasonField.className = 'reason-field';
            const chantingReasonInput = document.createElement('input');
            chantingReasonInput.type = 'text';
            chantingReasonInput.placeholder = 'Reason for absent/late (optional)';
            chantingReasonInput.value = chantingReason;
            chantingReasonInput.onblur = () => saveData();
            chantingReasonField.appendChild(chantingReasonInput);
            
            chantingCell.appendChild(chantingSelect);
            chantingCell.appendChild(chantingReasonField);
            toggleReasonField(chantingSelect, chantingReasonField);
            
            // MA cell
            const maCell = document.createElement('td');
            const maSelect = document.createElement('select');
            maSelect.innerHTML = '<option value="Present">Present</option><option value="Absent">Absent</option><option value="Late">Late</option>';
            maSelect.value = ma;
            maSelect.onchange = () => {
                toggleReasonField(maSelect, maReasonField);
            };
            
            const maReasonField = document.createElement('div');
            maReasonField.className = 'reason-field';
            const maReasonInput = document.createElement('input');
            maReasonInput.type = 'text';
            maReasonInput.placeholder = 'Reason for absent/late (optional)';
            maReasonInput.value = maReason;
            maReasonInput.onblur = () => saveData();
            maReasonField.appendChild(maReasonInput);
            
            maCell.appendChild(maSelect);
            maCell.appendChild(maReasonField);
            toggleReasonField(maSelect, maReasonField);
            
            // SB cell
            const sbCell = document.createElement('td');
            const sbSelect = document.createElement('select');
            sbSelect.innerHTML = '<option value="Present">Present</option><option value="Absent">Absent</option><option value="Late">Late</option>';
            sbSelect.value = sb;
            sbSelect.onchange = () => {
                toggleReasonField(sbSelect, sbReasonField);
            };
            
            const sbReasonField = document.createElement('div');
            sbReasonField.className = 'reason-field';
            const sbReasonInput = document.createElement('input');
            sbReasonInput.type = 'text';
            sbReasonInput.placeholder = 'Reason for absent/late (optional)';
            sbReasonInput.value = sbReason;
            sbReasonInput.onblur = () => saveData();
            sbReasonField.appendChild(sbReasonInput);
            
            sbCell.appendChild(sbSelect);
            sbCell.appendChild(sbReasonField);
            toggleReasonField(sbSelect, sbReasonField);
            
            // Actions cell
            const actionsCell = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = async () => {
                if (confirm('Are you sure you want to delete this row?')) {
                    row.remove();
                    await saveData();
                }
            };
            actionsCell.appendChild(deleteBtn);
            
            row.appendChild(nameCell);
            row.appendChild(chantingCell);
            row.appendChild(maCell);
            row.appendChild(sbCell);
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
        }

        // Generate message content
        function generateMessage() {
            let message = "Today's full morning program attendance - \n";
            message += "Name - Chanting, MA, SB class\n\n";
            
            const rows = tableBody.querySelectorAll('tr');
            let hasData = false;
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 5) {
                    const nameInput = cells[0].querySelector('input');
                    const chantingSelect = cells[1].querySelector('select');
                    const chantingReasonInput = cells[1].querySelector('.reason-field input');
                    const maSelect = cells[2].querySelector('select');
                    const maReasonInput = cells[2].querySelector('.reason-field input');
                    const sbSelect = cells[3].querySelector('select');
                    const sbReasonInput = cells[3].querySelector('.reason-field input');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    if (name) {
                        let chantingStatus = chantingSelect.value === 'Present' ? 'P' : chantingSelect.value === 'Absent' ? 'A' : 'L';
                        const chantingReason = chantingReasonInput ? chantingReasonInput.value.trim() : '';
                        if ((chantingStatus === 'A' || chantingStatus === 'L') && chantingReason) {
                            chantingStatus += ` (${chantingReason})`;
                        }
                        
                        let maStatus = maSelect.value === 'Present' ? 'P' : maSelect.value === 'Absent' ? 'A' : 'L';
                        const maReason = maReasonInput ? maReasonInput.value.trim() : '';
                        if ((maStatus === 'A' || maStatus === 'L') && maReason) {
                            maStatus += ` (${maReason})`;
                        }
                        
                        let sbStatus = sbSelect.value === 'Present' ? 'P' : sbSelect.value === 'Absent' ? 'A' : 'L';
                        const sbReason = sbReasonInput ? sbReasonInput.value.trim() : '';
                        if ((sbStatus === 'A' || sbStatus === 'L') && sbReason) {
                            sbStatus += ` (${sbReason})`;
                        }
                        
                        message += `${name} - ${chantingStatus}, ${maStatus}, ${sbStatus}\n`;
                        hasData = true;
                    }
                }
            });
            
            if (!hasData) {
                message += "No attendance data recorded.";
            }
            
            return message;
        }

        // Send SMS
        async function sendSMS() {
            await savePhoneNumber(); // Ensure phone is saved
            const phone = phoneNumberInput.value.trim();
            if (!phone || phone.length !== 10 || !/^\d{10}$/.test(phone)) {
                alert('Please enter a valid 10-digit Indian phone number.');
                return;
            }
            
            const message = generateMessage();
            const encodedMessage = encodeURIComponent(message);
            const smsUrl = `sms:+91${phone}?body=${encodedMessage}`;
            window.open(smsUrl, '_blank');
        }

        // Event listeners
        addRowBtn.onclick = async () => {
            addRow();
            await saveData(); // Save immediately after adding
        };
        
        sendMessageBtn.onclick = sendSMS;

        // Force save on page unload/refresh
        window.addEventListener('beforeunload', async () => {
            await saveData();
            await savePhoneNumber();
        });

        // Initialize DB and load data on page load
        initDB().then(async () => {
            await loadData();
            await loadPhoneNumber();
        });

        // Save phone number on blur
        phoneNumberInput.onblur = savePhoneNumber;
    </script>
</body>
</html>
